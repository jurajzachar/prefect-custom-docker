# a declarative deployment spec Prefect can use to build an image and register a deployment.
# see https://docs.prefect.io/v3/how-to-guides/deployments/prefect-yaml

name: thorium-etl
version: null

# Build step disabled (using pre-built image)
build: null
push: null

# Pull step
pull: null

# Deployments
deployments:
  - name: backfill_binance_trades
    version: null
    tags: ["production"]
    description: "Production deployment for backfilling Binance trades from local JSON"
    entrypoint: prefect_custom_docker.proxy:docker_flow
    work_pool:
      name: docker-pool  # Your Prefect work pool name
      work_queue_name: default
      job_variables:
        image: "{{ DOCKER_REGISTRY }}/prefect-custom-docker:latest"
        env:
          IMAGE: "{{ DOCKER_REGISTRY }}/binance-trade-ingestion:latest"
          VOLUMES: "/lithium/data/binance/trades:/opt/data"
          DB_HOST_ENV: "{{ prefect.variables.thorium_etl_db_host_env }}"
          DB_NAME_ENV: "{{ prefect.variables.thorium_etl_db_name_env }}"
          DB_PASSWORD_ENV: "{{ prefect.variables.thorium_etl_db_password_env }}"
          DB_PORT_ENV: "{{ prefect.variables.thorium_etl_db_port_env }}"
          DB_USER_ENV: "{{ prefect.variables.thorium_etl_db_user_env }}"
          TARGET_FOLDER_ENV: "/opt/data"
    schedule:
      cron: "0 23 * * *"  # Every day at 11pm
      timezone: "UTC"
    concurrency_limit:
      limit: 1
      collision_strategy: CANCEL_NEW